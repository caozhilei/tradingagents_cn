# Frontend Dockerfile for Vue 3 + Vite app (TradingAgents-CN v1.0.0-preview)
# 前后端分离架构 - 前端服务

# 构建阶段：使用Node.js 22.x（与项目开发环境一致）
# 使用腾讯云镜像源加速下载（如果 Docker daemon 已配置镜像加速，会自动使用）
FROM node:22-alpine AS build

# 代理配置（从构建参数传入）
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY
# API 基础 URL（构建时传入，Docker 环境使用空字符串，通过 Nginx 反向代理）
ARG VITE_API_BASE_URL=""

ENV NODE_ENV=production
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
WORKDIR /app/frontend

# 设置代理环境变量（如果提供了代理参数）
ENV http_proxy=${HTTP_PROXY}
ENV https_proxy=${HTTPS_PROXY}
ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
ENV no_proxy=${NO_PROXY}
ENV NO_PROXY=${NO_PROXY}

# 复制package.json和package-lock.json
COPY frontend/package.json frontend/package-lock.json ./

# 清理可能存在的node_modules目录
RUN rm -rf node_modules

# 安装所有依赖（包括devDependencies），确保vite被正确安装
RUN npm install --include=dev --network-timeout=300000

# 复制前端源代码
COPY frontend/. ./

# 复制根目录的静态资源与文档到构建环境
# - assets: 提供 /assets/* 静态资源（前端使用绝对路径）
# - docs: 提供 Article.vue 中通过 ?raw 引用的 Markdown 文档
COPY assets /app/frontend/public/assets
COPY docs /app/docs

# 构建生产版本（使用build:skip-check跳过类型检查，加快构建速度）
RUN npm run build:skip-check

# 运行阶段：使用Nginx提供静态文件服务
# 使用腾讯云镜像源加速下载（如果 Docker daemon 已配置镜像加速，会自动使用）
FROM nginx:alpine AS runtime

WORKDIR /usr/share/nginx/html

# 从构建阶段复制构建产物
COPY --from=build /app/frontend/dist .

# 复制Nginx配置（支持SPA路由）
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

# 配置日志管理
RUN mkdir -p /var/log/nginx && \
    touch /var/log/nginx/access.log && \
    touch /var/log/nginx/error.log

# 安全加固
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html && \
    # 移除默认的nginx配置文件
    rm -f /etc/nginx/conf.d/default.conf.default && \
    # 配置nginx用户和组
    sed -i 's/user nginx;/user nginx nginx;/g' /etc/nginx/nginx.conf && \
    # 限制worker进程数量
    sed -i 's/worker_processes auto;/worker_processes 1;/g' /etc/nginx/nginx.conf && \
    # 配置worker_connections
    sed -i 's/worker_connections 1024;/worker_connections 512;/g' /etc/nginx/nginx.conf

# 暴露端口80
EXPOSE 80

# 健康检查
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD wget -q -O - http://localhost/health || exit 1

# 启动Nginx
CMD ["nginx", "-g", "daemon off;"]