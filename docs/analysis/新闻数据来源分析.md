# 新闻数据来源分析报告

## 📋 概述

本项目采用**多数据源架构**，支持从多个新闻源获取股票相关新闻，并提供自动降级机制确保数据可用性。

## 🎯 数据源优先级

新闻数据获取遵循以下优先级顺序：

```
MongoDB（缓存） → Tushare → AKShare → 实时新闻聚合器
```

### 1. MongoDB（最高优先级）

**位置**: `tradingagents/dataflows/data_source_manager.py:2105`

- **作用**: 作为新闻数据的缓存层，存储已同步的新闻数据
- **优势**: 
  - 查询速度快
  - 减少外部API调用
  - 支持历史新闻查询
- **数据来源**: 由同步服务从其他数据源获取后存储
- **集合名称**: `stock_news`

## 📰 主要新闻数据源

### 2. Tushare 新闻源（9个新闻源）

**位置**: `tradingagents/dataflows/providers/china/tushare.py:768`

**支持的新闻源**（按优先级排序）：

1. **sina** - 新浪财经
2. **eastmoney** - 东方财富
3. **10jqka** - 同花顺
4. **wallstreetcn** - 华尔街见闻
5. **cls** - 财联社
6. **yicai** - 第一财经
7. **jinrongjie** - 金融界
8. **yuncaijing** - 云财经
9. **fenghuang** - 凤凰财经

**特点**:
- 需要 Tushare API Token（需权限）
- 支持回溯时间范围（默认24小时，最多7天）
- 自动情绪分析和关键词提取
- 数据质量高，但受API限制

**实现方法**: `get_stock_news()`

### 3. AKShare 新闻源（2个新闻源）

**位置**: `tradingagents/dataflows/providers/china/akshare.py:1110`

**支持的新闻源**:

1. **东方财富个股新闻** (`stock_news_em`)
   - 通过 `ak.stock_news_em()` 获取
   - 支持A股和港股
   - 免费使用

2. **CCTV市场新闻** (`news_cctv`)
   - 通过 `ak.news_cctv()` 获取
   - 市场整体新闻
   - 免费使用

**特点**:
- 完全免费，无需API Key
- 适合A股和港股
- 数据更新及时
- 支持情绪分析和分类

**实现方法**: 
- `get_stock_news_sync()` - 同步版本
- `get_stock_news()` - 异步版本

### 4. 实时新闻聚合器

**位置**: `tradingagents/dataflows/news/realtime_news.py:37`

**聚合的新闻源**（按优先级排序）:

#### 4.1 专业金融API

1. **FinnHub** (`_get_finnhub_realtime_news`)
   - 需要 `FINNHUB_API_KEY` 环境变量
   - 支持美股、港股、A股
   - 提供公司新闻API
   - 数据质量高，实时性强

2. **Alpha Vantage** (`_get_alpha_vantage_news`)
   - 需要 `ALPHA_VANTAGE_API_KEY` 环境变量
   - 支持 `NEWS_SENTIMENT` 接口
   - 提供情绪分析数据
   - 主要支持美股

3. **NewsAPI** (`_get_newsapi_news`)
   - 需要 `NEWSAPI_KEY` 环境变量
   - 支持多语言新闻
   - 主要支持英文新闻

#### 4.2 中文财经新闻

**位置**: `tradingagents/dataflows/news/realtime_news.py:303`

1. **东方财富新闻**（通过AKShare）
   - 使用 `AKShareProvider.get_stock_news_sync()`
   - 支持A股和港股
   - 免费使用

2. **财联社RSS**
   - RSS源解析
   - 需要 `feedparser` 库
   - 市场新闻聚合

#### 4.3 搜索引擎新闻

**位置**: `tradingagents/dataflows/news/google_news.py:44`

1. **Google News** (`getNewsData`)
   - 通过网页爬取获取
   - 支持多语言搜索
   - 无需API Key
   - 有速率限制和反爬虫机制

**特点**:
- 支持多市场（A股、港股、美股）
- 自动去重和排序
- 评估新闻紧急程度
- 计算相关性分数

### 5. 其他新闻源（可选）

**位置**: `tradingagents/dataflows/news/`

1. **Reddit** (`reddit.py`)
   - 社交媒体新闻
   - 需要配置
   - 可选功能

2. **Chinese Finance Aggregator** (`chinese_finance.py`)
   - 中文财经数据聚合器
   - 可选功能

## 🔄 数据同步流程

**位置**: `app/worker/news_data_sync_service.py:45`

### 同步服务 (`NewsDataSyncService`)

支持从多个数据源同步新闻：

1. **Tushare新闻同步** (`_sync_tushare_news`)
   - 调用 Tushare Provider
   - 标准化新闻数据
   - 添加情绪分析和分类

2. **AKShare新闻同步** (`_sync_akshare_news`)
   - 调用 AKShare Provider
   - 获取东方财富和CCTV新闻
   - 标准化数据格式

3. **实时新闻同步** (`_sync_realtime_news`)
   - 使用实时新闻聚合器
   - 聚合多个API源
   - 去重和排序

### 数据标准化

所有新闻数据都会经过标准化处理：

- **基础信息**: symbol, title, content, url, source, author
- **时间信息**: publish_time
- **分类标签**: category, sentiment, importance, keywords
- **元数据**: data_source, created_at, updated_at

## 💾 数据存储

**位置**: `app/services/news_data_service.py:78`

### MongoDB集合结构

- **集合名称**: `stock_news`
- **索引**:
  - 唯一索引: `url + title + publish_time`
  - 股票代码索引: `symbol`
  - 发布时间索引: `publish_time`
  - 复合索引: `symbol + publish_time`
  - 分类索引: `category`, `sentiment`, `importance`

### 数据模型

```javascript
{
  "symbol": "000001",           // 股票代码
  "full_symbol": "000001.SZ",   // 完整代码
  "market": "CN",               // 市场
  "title": "新闻标题",
  "content": "新闻内容",
  "summary": "摘要",
  "url": "https://...",
  "source": "sina",             // 新闻来源
  "publish_time": "2025-01-01 12:00:00",
  "category": "general",        // 分类
  "sentiment": "neutral",       // 情绪
  "sentiment_score": 0.0,       // 情绪分数
  "keywords": ["关键词1"],      // 关键词
  "importance": "medium",       // 重要性
  "data_source": "tushare",     // 数据源
  "created_at": "2025-01-01 12:00:00",
  "updated_at": "2025-01-01 12:00:00"
}
```

## 🔍 新闻查询接口

**位置**: `app/routers/news_data.py:44`

### 主要接口

1. **查询股票新闻** (`query_stock_news`)
   - 支持按股票代码查询
   - 支持时间范围过滤
   - 支持分类和情绪过滤

2. **高级查询** (`query_news_advanced`)
   - 多条件组合查询
   - 全文搜索
   - 统计信息

## 📊 数据源对比

| 数据源 | 新闻源数量 | 费用 | API限制 | 数据质量 | 适用市场 |
|--------|----------|------|--------|---------|---------|
| **MongoDB** | 缓存 | 免费 | 无 | 高 | 所有 |
| **Tushare** | 9个 | 需权限 | 有 | 高 | A股为主 |
| **AKShare** | 2个 | 免费 | 较宽松 | 中 | A股、港股 |
| **FinnHub** | 1个 | 需API Key | 有 | 高 | 美股、港股、A股 |
| **Alpha Vantage** | 1个 | 需API Key | 有 | 高 | 美股为主 |
| **NewsAPI** | 聚合 | 需API Key | 有 | 中 | 全球 |
| **Google News** | 聚合 | 免费 | 有 | 中 | 全球 |

## 🎯 使用建议

### 1. A股新闻获取

**推荐优先级**:
1. MongoDB缓存（如果已同步）
2. AKShare东方财富（免费，数据及时）
3. Tushare（需权限，数据质量高）
4. 实时新闻聚合器

### 2. 港股新闻获取

**推荐优先级**:
1. MongoDB缓存
2. AKShare东方财富
3. FinnHub（如果配置了API Key）
4. Google News

### 3. 美股新闻获取

**推荐优先级**:
1. MongoDB缓存
2. FinnHub（推荐）
3. Alpha Vantage
4. NewsAPI
5. Google News

## ⚙️ 配置要求

### 必需配置

- **MongoDB连接**: 用于存储新闻数据
- **Tushare Token** (可选): 用于Tushare新闻源
  - 环境变量: `TUSHARE_TOKEN`
  - 或数据库配置

### 可选配置

- **FinnHub API Key**: `FINNHUB_API_KEY`
- **Alpha Vantage API Key**: `ALPHA_VANTAGE_API_KEY`
- **NewsAPI Key**: `NEWSAPI_KEY`

## 📝 相关文档

- [新闻数据同步功能](../features/news/NEWS_SYNC_FEATURE.md)
- [数据源管理器增强](../integration/data-sources/DATA_SOURCE_MANAGER_ENHANCEMENT.md)
- [FAQ - 数据来源](../learning/08-faq/general-questions.md)

## 🔄 更新历史

- **2025-01-XX**: 创建新闻数据来源分析文档
- 支持多数据源自动降级
- 实现新闻数据标准化和情绪分析
- 添加实时新闻聚合功能

