# 环境变量配置指南

## 📋 概述

TradingAgents-CN 使用 `.env` 文件管理环境变量配置，包括数据库连接、API密钥、数据同步任务等。

## 📁 配置文件位置

- **模板文件**: `.env.example`（项目根目录）
- **实际配置**: `.env`（项目根目录，需要手动创建）
- **注意**: `.env` 文件已加入 `.gitignore`，不会提交到版本控制系统

## 🚀 快速开始

### 步骤1: 创建 .env 文件

```bash
# 复制模板文件
cp .env.example .env

# 或手动创建
touch .env
```

### 步骤2: 编辑配置

使用文本编辑器打开 `.env` 文件，根据实际情况修改配置值。

## 📊 MongoDB 数据库配置

### 配置项说明

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `MONGODB_HOST` | MongoDB主机地址 | `localhost` | `localhost` 或 `mongodb` |
| `MONGODB_PORT` | MongoDB端口号 | `27017` | `27017` |
| `MONGODB_USERNAME` | 用户名 | `""`（空） | `admin` |
| `MONGODB_PASSWORD` | 密码 | `""`（空） | `tradingagents123` |
| `MONGODB_DATABASE` | 数据库名称 | `tradingagents` | `tradingagents` |
| `MONGODB_AUTH_SOURCE` | 认证源 | `admin` | `admin` |

### 配置示例

#### 本地开发环境（无认证）

```bash
MONGODB_HOST=localhost
MONGODB_PORT=27017
MONGODB_USERNAME=
MONGODB_PASSWORD=
MONGODB_DATABASE=tradingagents
MONGODB_AUTH_SOURCE=admin
```

#### Docker环境（有认证）

```bash
MONGODB_HOST=mongodb
MONGODB_PORT=27017
MONGODB_USERNAME=admin
MONGODB_PASSWORD=tradingagents123
MONGODB_DATABASE=tradingagents
MONGODB_AUTH_SOURCE=admin
```

#### 宿主机运行（Docker Compose）

```bash
MONGODB_HOST=localhost
MONGODB_PORT=27017
MONGODB_USERNAME=admin
MONGODB_PASSWORD=tradingagents123
MONGODB_DATABASE=tradingagents
MONGODB_AUTH_SOURCE=admin
```

### 连接字符串自动生成

应用会根据以上配置自动生成MongoDB连接字符串：

- **有认证**: `mongodb://username:password@host:port/database?authSource=auth_source`
- **无认证**: `mongodb://host:port/database`

## 🔄 财务数据同步配置

### AKShare财务数据同步

```bash
# 启用AKShare统一数据同步
AKSHARE_UNIFIED_ENABLED=true

# 启用财务数据同步
AKSHARE_FINANCIAL_SYNC_ENABLED=true

# 财务数据同步时间（CRON表达式）
# 每周日凌晨4点执行
AKSHARE_FINANCIAL_SYNC_CRON=0 4 * * 0
```

### Tushare财务数据同步

```bash
# 启用Tushare统一数据同步
TUSHARE_UNIFIED_ENABLED=true

# 启用财务数据同步
TUSHARE_FINANCIAL_SYNC_ENABLED=true

# 财务数据同步时间（CRON表达式）
# 每周日凌晨4点执行
TUSHARE_FINANCIAL_SYNC_CRON=0 4 * * 0

# Tushare Token（必需）
TUSHARE_TOKEN=your_tushare_token_here
```

### CRON表达式说明

| 表达式 | 说明 | 示例 |
|--------|------|------|
| `0 4 * * 0` | 每周日凌晨4点 | 财务数据同步 |
| `0 3 * * *` | 每天凌晨3点 | 基础信息同步 |
| `*/30 9-15 * * 1-5` | 工作日9-15点每30分钟 | 行情同步 |
| `0 17 * * 1-5` | 工作日17点 | 历史数据同步 |

## 🔍 配置验证

### 方法1: 使用诊断脚本

```bash
# 验证MongoDB连接和财务数据
py scripts/使用应用配置诊断财务数据.py
```

### 方法2: 检查应用启动日志

启动应用时，日志会显示配置摘要：

```
📋 TradingAgents-CN Configuration Summary
MongoDB: localhost:27017/tradingagents
Redis: localhost:6379/0
```

### 方法3: 测试数据库连接

```python
from app.core.config import settings
from pymongo import MongoClient

# 构建连接
connect_kwargs = {
    "host": settings.MONGODB_HOST,
    "port": settings.MONGODB_PORT
}

if settings.MONGODB_USERNAME and settings.MONGODB_PASSWORD:
    connect_kwargs.update({
        "username": settings.MONGODB_USERNAME,
        "password": settings.MONGODB_PASSWORD,
        "authSource": settings.MONGODB_AUTH_SOURCE
    })

client = MongoClient(**connect_kwargs)
client.admin.command('ping')
print("✅ MongoDB连接成功")
```

## 🛠️ 常见配置场景

### 场景1: 本地开发（无Docker）

```bash
MONGODB_HOST=localhost
MONGODB_PORT=27017
MONGODB_USERNAME=
MONGODB_PASSWORD=
MONGODB_DATABASE=tradingagents
MONGODB_AUTH_SOURCE=admin
```

### 场景2: Docker Compose（宿主机运行）

```bash
MONGODB_HOST=localhost
MONGODB_PORT=27017
MONGODB_USERNAME=admin
MONGODB_PASSWORD=tradingagents123
MONGODB_DATABASE=tradingagents
MONGODB_AUTH_SOURCE=admin
```

### 场景3: Docker容器内运行

```bash
MONGODB_HOST=mongodb
MONGODB_PORT=27017
MONGODB_USERNAME=admin
MONGODB_PASSWORD=tradingagents123
MONGODB_DATABASE=tradingagents
MONGODB_AUTH_SOURCE=admin
```

### 场景4: 远程MongoDB服务器

```bash
MONGODB_HOST=your-mongodb-server.com
MONGODB_PORT=27017
MONGODB_USERNAME=your_username
MONGODB_PASSWORD=your_password
MONGODB_DATABASE=tradingagents
MONGODB_AUTH_SOURCE=admin
```

## ⚠️ 注意事项

### 1. 敏感信息保护

- ✅ **不要**将 `.env` 文件提交到版本控制系统
- ✅ **不要**在代码中硬编码密码
- ✅ **使用**环境变量或密钥管理服务

### 2. 配置优先级

配置加载优先级（高→低）：
1. 进程环境变量
2. `.env` 文件
3. 代码默认值

### 3. 配置验证

- 应用启动时会验证关键配置
- 如果配置错误，应用会显示错误信息
- 建议使用诊断脚本验证配置

### 4. Docker环境特殊说明

- **容器内**: 使用服务名（如 `mongodb`、`redis`）
- **宿主机**: 使用 `localhost` 或 `127.0.0.1`
- **端口映射**: 确保端口映射正确

## 📝 完整配置示例

查看 `.env.example` 文件获取完整的配置模板。

## 🔗 相关文档

- [配置矩阵](../configuration/CONFIG_MATRIX.md)
- [配置管理设计](../design/configuration_management.md)
- [Docker部署指南](../../DOCKER_DEPLOYMENT.md)
- [基本面数据诊断](../../故障排除/基本面数据诊断结果.md)

---

**最后更新**: 2025-01-13

