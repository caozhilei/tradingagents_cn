# åŸºæœ¬é¢æ•°æ®ä¸è¶³é—®é¢˜ - æ·±åº¦æ’æŸ¥æŠ¥å‘Š

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

ç»è¿‡æ·±å…¥ä»£ç å®¡æŸ¥ï¼Œå‘ç°äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

### é—®é¢˜1: MongoDBæŸ¥è¯¢æ¡ä»¶ä¸å®Œæ•´ âš ï¸ **ä¸¥é‡**

**ä½ç½®**: `tradingagents/dataflows/cache/mongodb_cache_adapter.py:236-238`

**é—®é¢˜**:
```python
query = {
    "code": code6,
    "data_source": data_source
}
```

**åˆ†æ**:
- æ•°æ®åº“ä¸­è´¢åŠ¡æ•°æ®å¯èƒ½ä½¿ç”¨ `symbol` å­—æ®µè€Œä¸æ˜¯ `code` å­—æ®µ
- æˆ–è€…åŒæ—¶å­˜åœ¨ä¸¤ä¸ªå­—æ®µ
- å½“å‰æŸ¥è¯¢åªæ£€æŸ¥ `code`ï¼Œå¯èƒ½æ¼æ‰ä½¿ç”¨ `symbol` çš„è®°å½•

**å½±å“**: å¯¼è‡´æ— æ³•ä»MongoDBè·å–å·²åŒæ­¥çš„è´¢åŠ¡æ•°æ®

### é—®é¢˜2: TushareåŸºæœ¬é¢æ•°æ®æ–¹æ³•æœªå®ç° âš ï¸ **ä¸¥é‡**

**ä½ç½®**: `tradingagents/dataflows/data_source_manager.py:1888-1891`

**é—®é¢˜**:
```python
def _get_tushare_fundamentals(self, symbol: str) -> str:
    """ä» Tushare è·å–åŸºæœ¬é¢æ•°æ® - æš‚æ—¶ä¸å¯ç”¨ï¼Œéœ€è¦å®ç°"""
    logger.warning(f"âš ï¸ TushareåŸºæœ¬é¢æ•°æ®åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨")
    return f"âš ï¸ TushareåŸºæœ¬é¢æ•°æ®åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–æ•°æ®æº"
```

**åˆ†æ**:
- æ–¹æ³•åªæ˜¯è¿”å›è­¦å‘Šæ¶ˆæ¯ï¼Œæ²¡æœ‰å®é™…è·å–æ•°æ®
- å³ä½¿Tushareæ•°æ®æºå¯ç”¨ï¼Œä¹Ÿæ— æ³•è·å–åŸºæœ¬é¢æ•°æ®

**å½±å“**: Tushareæ•°æ®æºæ— æ³•æä¾›åŸºæœ¬é¢æ•°æ®

### é—®é¢˜3: AKShareåŸºæœ¬é¢æ•°æ®æ–¹æ³•æœªå®ç° âš ï¸ **ä¸¥é‡**

**ä½ç½®**: `tradingagents/dataflows/data_source_manager.py:1893-1904`

**é—®é¢˜**:
```python
def _get_akshare_fundamentals(self, symbol: str) -> str:
    """ä» AKShare ç”ŸæˆåŸºæœ¬é¢åˆ†æ"""
    # AKShare æ²¡æœ‰ç›´æ¥çš„åŸºæœ¬é¢æ•°æ®æ¥å£ï¼Œä½¿ç”¨ç”Ÿæˆåˆ†æ
    return self._generate_fundamentals_analysis(symbol)
```

**åˆ†æ**:
- æ–¹æ³•æ²¡æœ‰è°ƒç”¨AKShareçš„ `get_financial_data` æ–¹æ³•
- åªæ˜¯ç”ŸæˆåŸºæœ¬åˆ†æï¼Œæ²¡æœ‰çœŸå®è´¢åŠ¡æ•°æ®

**å½±å“**: AKShareæ•°æ®æºæ— æ³•æä¾›çœŸå®è´¢åŠ¡æ•°æ®

### é—®é¢˜4: æ•°æ®æºé™çº§é€»è¾‘å¯èƒ½å¤±æ•ˆ âš ï¸ **ä¸­ç­‰**

**ä½ç½®**: `tradingagents/dataflows/data_source_manager.py:2071-2103`

**åˆ†æ**:
- é™çº§é€»è¾‘ä¾èµ– `_get_tushare_fundamentals` å’Œ `_get_akshare_fundamentals`
- ç”±äºè¿™ä¸¤ä¸ªæ–¹æ³•æœªå®ç°ï¼Œé™çº§ä¹Ÿä¼šå¤±è´¥
- æœ€ç»ˆåªèƒ½ç”ŸæˆåŸºæœ¬åˆ†æï¼Œæ²¡æœ‰çœŸå®æ•°æ®

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ä¿®å¤MongoDBæŸ¥è¯¢æ¡ä»¶

**æ–‡ä»¶**: `tradingagents/dataflows/cache/mongodb_cache_adapter.py`

**ä¿®æ”¹**:
```python
def get_financial_data(self, symbol: str, report_period: str = None) -> Optional[Dict[str, Any]]:
    """è·å–è´¢åŠ¡æ•°æ®ï¼ŒæŒ‰æ•°æ®æºä¼˜å…ˆçº§æŸ¥è¯¢"""
    if not self.use_app_cache or self.db is None:
        return None

    try:
        code6 = str(symbol).zfill(6)
        collection = self.db.stock_financial_data

        # è·å–æ•°æ®æºä¼˜å…ˆçº§
        priority_order = self._get_data_source_priority(symbol)

        # æŒ‰ä¼˜å…ˆçº§æŸ¥è¯¢
        for data_source in priority_order:
            # ğŸ”¥ ä¿®å¤ï¼šåŒæ—¶æŸ¥è¯¢ code å’Œ symbol å­—æ®µ
            query = {
                "$or": [
                    {"code": code6},
                    {"symbol": code6}
                ],
                "data_source": data_source
            }
            if report_period:
                query["report_period"] = report_period

            # è·å–æœ€æ–°çš„è´¢åŠ¡æ•°æ®
            doc = collection.find_one(query, {"_id": 0}, sort=[("report_period", -1)])

            if doc:
                logger.info(f"âœ… [æ•°æ®æ¥æº: MongoDB-{data_source}] {symbol}è´¢åŠ¡æ•°æ®")
                return doc

        return None
    except Exception as e:
        logger.warning(f"âš ï¸ è·å–è´¢åŠ¡æ•°æ®å¤±è´¥: {e}")
        return None
```

### ä¿®å¤2: å®ç°TushareåŸºæœ¬é¢æ•°æ®è·å–

**æ–‡ä»¶**: `tradingagents/dataflows/data_source_manager.py`

**ä¿®æ”¹**:
```python
def _get_tushare_fundamentals(self, symbol: str) -> str:
    """ä» Tushare è·å–åŸºæœ¬é¢æ•°æ®"""
    try:
        from tradingagents.dataflows.providers.china.tushare import get_tushare_provider
        
        provider = get_tushare_provider()
        if not provider.is_available():
            logger.warning(f"âš ï¸ Tushareæ•°æ®æºä¸å¯ç”¨")
            return self._try_fallback_fundamentals(symbol)
        
        # è·å–è´¢åŠ¡æ•°æ®
        financial_data = await provider.get_financial_data(symbol, report_type="quarterly")
        
        if financial_data:
            # æ ¼å¼åŒ–è´¢åŠ¡æ•°æ®
            return self._format_financial_data(symbol, [financial_data])
        else:
            logger.warning(f"âš ï¸ Tushareæœªè·å–åˆ°{symbol}çš„è´¢åŠ¡æ•°æ®")
            return self._try_fallback_fundamentals(symbol)
            
    except Exception as e:
        logger.error(f"âŒ è·å–TushareåŸºæœ¬é¢æ•°æ®å¤±è´¥: {e}")
        return self._try_fallback_fundamentals(symbol)
```

**æ³¨æ„**: è¿™ä¸ªæ–¹æ³•éœ€è¦æ”¹ä¸ºå¼‚æ­¥æ–¹æ³•ï¼Œæˆ–è€…ä½¿ç”¨åŒæ­¥æ–¹å¼è°ƒç”¨ã€‚

### ä¿®å¤3: å®ç°AKShareåŸºæœ¬é¢æ•°æ®è·å–

**æ–‡ä»¶**: `tradingagents/dataflows/data_source_manager.py`

**ä¿®æ”¹**:
```python
def _get_akshare_fundamentals(self, symbol: str) -> str:
    """ä» AKShare è·å–åŸºæœ¬é¢æ•°æ®"""
    try:
        from tradingagents.dataflows.providers.china.akshare import get_akshare_provider
        
        provider = get_akshare_provider()
        if not provider.is_available():
            logger.warning(f"âš ï¸ AKShareæ•°æ®æºä¸å¯ç”¨")
            return self._try_fallback_fundamentals(symbol)
        
        # è·å–è´¢åŠ¡æ•°æ®
        financial_data = await provider.get_financial_data(symbol)
        
        if financial_data:
            # ä»AKShareæ•°æ®ä¸­æå–å…³é”®æŒ‡æ ‡
            formatted_data = self._extract_akshare_financial_indicators(symbol, financial_data)
            return formatted_data
        else:
            logger.warning(f"âš ï¸ AKShareæœªè·å–åˆ°{symbol}çš„è´¢åŠ¡æ•°æ®")
            return self._try_fallback_fundamentals(symbol)
            
    except Exception as e:
        logger.error(f"âŒ è·å–AKShareåŸºæœ¬é¢æ•°æ®å¤±è´¥: {e}")
        return self._try_fallback_fundamentals(symbol)
```

### ä¿®å¤4: æ£€æŸ¥OptimizedChinaDataProvider

**æ–‡ä»¶**: `tradingagents/dataflows/optimized_china_data.py`

**éœ€è¦æ£€æŸ¥**:
- `_generate_fundamentals_report` æ–¹æ³•æ˜¯å¦æ­£ç¡®ä»MongoDBè·å–è´¢åŠ¡æ•°æ®
- æ˜¯å¦è°ƒç”¨äº† `get_financial_data_with_fallback`

## ğŸ“Š éªŒè¯æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“ä¸­çš„è´¢åŠ¡æ•°æ®

```python
from app.core.database import get_mongo_db

db = get_mongo_db()
collection = db["stock_financial_data"]

# æ£€æŸ¥æ•°æ®æ•°é‡
count = await collection.count_documents({})
print(f"è´¢åŠ¡æ•°æ®æ€»æ•°: {count}")

# æ£€æŸ¥ç¤ºä¾‹è‚¡ç¥¨
doc = await collection.find_one({
    "$or": [
        {"code": "000001"},
        {"symbol": "000001"}
    ]
})
print(f"ç¤ºä¾‹æ•°æ®: {doc}")
```

### æ­¥éª¤2: æµ‹è¯•MongoDBç¼“å­˜é€‚é…å™¨

```python
from tradingagents.dataflows.cache.mongodb_cache_adapter import get_mongodb_cache_adapter

adapter = get_mongodb_cache_adapter()
data = adapter.get_financial_data("000001")
print(f"è·å–çš„è´¢åŠ¡æ•°æ®: {data}")
```

### æ­¥éª¤3: æµ‹è¯•æ•°æ®æºæä¾›è€…

```python
from tradingagents.dataflows.providers.china.tushare import get_tushare_provider
from tradingagents.dataflows.providers.china.akshare import get_akshare_provider

# æµ‹è¯•Tushare
tushare = get_tushare_provider()
if tushare.is_available():
    data = await tushare.get_financial_data("000001")
    print(f"Tushareè´¢åŠ¡æ•°æ®: {data}")

# æµ‹è¯•AKShare
akshare = get_akshare_provider()
if akshare.is_available():
    data = await akshare.get_financial_data("000001")
    print(f"AKShareè´¢åŠ¡æ•°æ®: {data}")
```

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

1. **ç«‹å³ä¿®å¤**: MongoDBæŸ¥è¯¢æ¡ä»¶ï¼ˆé—®é¢˜1ï¼‰
   - å½±å“æœ€å¤§ï¼Œä¿®å¤æœ€ç®€å•
   - å¯èƒ½è§£å†³å¤§éƒ¨åˆ†æ•°æ®è·å–é—®é¢˜

2. **å°½å¿«ä¿®å¤**: Tushareå’ŒAKShareåŸºæœ¬é¢æ•°æ®æ–¹æ³•ï¼ˆé—®é¢˜2ã€3ï¼‰
   - éœ€è¦å®ç°å®Œæ•´çš„æ•°æ®è·å–é€»è¾‘
   - å¯èƒ½éœ€è¦å¤„ç†å¼‚æ­¥è°ƒç”¨é—®é¢˜

3. **åç»­ä¼˜åŒ–**: æ•°æ®æºé™çº§é€»è¾‘ï¼ˆé—®é¢˜4ï¼‰
   - ç¡®ä¿é™çº§æœºåˆ¶æ­£å¸¸å·¥ä½œ
   - æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `tradingagents/dataflows/cache/mongodb_cache_adapter.py` - MongoDBç¼“å­˜é€‚é…å™¨
- `tradingagents/dataflows/data_source_manager.py` - æ•°æ®æºç®¡ç†å™¨
- `tradingagents/dataflows/providers/china/tushare.py` - Tushareæä¾›è€…
- `tradingagents/dataflows/providers/china/akshare.py` - AKShareæä¾›è€…
- `app/services/financial_data_service.py` - è´¢åŠ¡æ•°æ®æœåŠ¡
- `app/worker/financial_data_sync_service.py` - è´¢åŠ¡æ•°æ®åŒæ­¥æœåŠ¡

---

**æœ€åæ›´æ–°**: 2025-01-13
**çŠ¶æ€**: å¾…ä¿®å¤

