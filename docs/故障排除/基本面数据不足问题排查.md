# 基本面数据不足问题排查指南

## 📋 问题描述

在分析股票时，基本面数据严重不足，可能表现为：
- ROE（净资产收益率）缺失
- 负债率缺失
- 营业收入、净利润等财务指标缺失
- 基本面分析师报告内容不完整

## 🔍 排查步骤

### 步骤1: 运行诊断脚本

```bash
# 在项目根目录执行
python scripts/诊断基本面数据问题.py
```

诊断脚本会检查：
1. ✅ 数据库中的财务数据数量
2. ✅ 财务数据同步任务配置
3. ✅ 数据源提供者可用性
4. ✅ 测试获取财务数据
5. ✅ 基本面API接口逻辑

### 步骤2: 检查数据库中的财务数据

```python
# 使用MongoDB客户端或Python脚本
from app.core.database import get_mongo_db

db = get_mongo_db()
count = await db["stock_financial_data"].count_documents({})
print(f"财务数据记录数: {count}")
```

**预期结果**：
- 应该有至少几千条记录
- 如果为0，说明从未同步过财务数据

### 步骤3: 检查同步任务配置

检查 `.env` 文件或环境变量：

```bash
# Tushare配置
TUSHARE_UNIFIED_ENABLED=true
TUSHARE_FINANCIAL_SYNC_ENABLED=true
TUSHARE_FINANCIAL_SYNC_CRON=0 4 * * 0  # 每周日凌晨4点

# AKShare配置
AKSHARE_UNIFIED_ENABLED=true
AKSHARE_FINANCIAL_SYNC_ENABLED=true
AKSHARE_FINANCIAL_SYNC_CRON=0 4 * * 0  # 每周日凌晨4点
```

**常见问题**：
- ❌ `*_FINANCIAL_SYNC_ENABLED=false` - 同步任务被禁用
- ❌ `*_UNIFIED_ENABLED=false` - 数据源被禁用

### 步骤4: 检查数据源可用性

```python
from tradingagents.dataflows.providers.china.tushare import get_tushare_provider
from tradingagents.dataflows.providers.china.akshare import get_akshare_provider

# 检查Tushare
tushare = get_tushare_provider()
print(f"Tushare可用: {tushare.is_available()}")

# 检查AKShare
akshare = get_akshare_provider()
print(f"AKShare可用: {akshare.is_available()}")
```

**常见问题**：
- ❌ Tushare Token未配置或无效
- ❌ 网络连接问题
- ❌ 数据源库未安装

### 步骤5: 手动触发同步

如果自动同步任务未运行，可以手动触发：

#### 方法1: 使用Python脚本

```bash
# 同步所有股票
python scripts/快速同步财务数据.py

# 同步指定股票
python scripts/快速同步财务数据.py --symbols 000001 600000

# 同步单只股票
python scripts/快速同步财务数据.py --single 000001

# 指定数据源
python scripts/快速同步财务数据.py --sources tushare akshare
```

#### 方法2: 使用API接口

```bash
# 启动财务数据同步
curl -X POST http://localhost:8000/api/financial-data/sync/start \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "symbols": ["000001", "600000"],
    "data_sources": ["tushare", "akshare"],
    "report_types": ["quarterly", "annual"]
  }'
```

#### 方法3: 使用Web界面

1. 登录Web界面
2. 进入"数据管理" → "财务数据"
3. 点击"开始同步"按钮

## 🛠️ 解决方案

### 解决方案1: 启用同步任务

如果同步任务被禁用，需要启用：

```bash
# 编辑 .env 文件
TUSHARE_FINANCIAL_SYNC_ENABLED=true
AKSHARE_FINANCIAL_SYNC_ENABLED=true

# 重启应用
```

### 解决方案2: 配置数据源

如果数据源不可用，需要配置：

#### Tushare配置

1. 获取Tushare Token: https://tushare.pro/
2. 在Web界面配置：
   - 进入"系统配置" → "数据源配置"
   - 找到Tushare配置
   - 输入Token并启用

#### AKShare配置

AKShare无需Token，但需要：
- 确保网络连接正常
- 可能需要配置代理（如果网络受限）

### 解决方案3: 手动同步财务数据

如果自动同步失败，可以手动同步：

```python
# 使用快速同步脚本
python scripts/快速同步财务数据.py --symbols 000001 600000
```

### 解决方案4: 检查数据源接口

如果数据源可用但获取失败，检查接口实现：

```python
# 测试Tushare获取财务数据
from tradingagents.dataflows.providers.china.tushare import get_tushare_provider

provider = get_tushare_provider()
if provider.is_available():
    data = await provider.get_financial_data("000001", report_type="quarterly")
    print(data)
```

## 📊 验证修复

修复后，验证数据是否正常：

1. **检查数据库记录数**
   ```python
   count = await db["stock_financial_data"].count_documents({})
   assert count > 0, "财务数据记录数应该大于0"
   ```

2. **检查示例股票**
   ```python
   doc = await db["stock_financial_data"].find_one({"symbol": "000001"})
   assert doc is not None, "应该能找到000001的财务数据"
   assert "roe" in doc or "financial_indicators" in doc, "应该包含ROE字段"
   ```

3. **测试基本面API**
   ```bash
   curl http://localhost:8000/api/stocks/000001/fundamentals \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```
   
   应该返回包含ROE、负债率等字段的数据。

## 🔧 常见错误

### 错误1: "未找到财务数据"

**原因**：数据库中没有该股票的财务数据

**解决**：
1. 运行财务数据同步
2. 检查股票代码是否正确
3. 检查数据源是否支持该股票

### 错误2: "数据源不可用"

**原因**：数据源配置错误或网络问题

**解决**：
1. 检查数据源配置
2. 测试网络连接
3. 检查Token是否有效

### 错误3: "同步任务未运行"

**原因**：同步任务被禁用或配置错误

**解决**：
1. 检查 `.env` 配置
2. 检查调度器是否运行
3. 手动触发同步

## 📚 相关文档

- [财务数据同步服务](../app/worker/financial_data_sync_service.py)
- [财务数据服务](../app/services/financial_data_service.py)
- [基本面数据接口](../app/routers/stocks.py#L215)

## 💡 预防措施

1. **定期检查同步任务**
   - 每周检查一次同步任务是否正常运行
   - 查看日志确认同步成功

2. **监控数据质量**
   - 定期检查数据库中的财务数据数量
   - 验证关键字段（ROE、负债率）是否存在

3. **配置告警**
   - 如果同步失败，发送通知
   - 监控数据源可用性

---

**最后更新**: 2025-01-13

